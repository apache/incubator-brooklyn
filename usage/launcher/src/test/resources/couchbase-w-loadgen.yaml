name: Couchbase with Elastic Load Generator

services:

- type: brooklyn.entity.nosql.couchbase.CouchbaseCluster
  id: cb-cluster
  adminUsername: Administrator
  adminPassword: Password
  initialSize: 3
  createBuckets: [ { bucket: default } ]
  brooklyn.config:
    provisioning.properties:
      minRam: 16384
      minCores: 4
  brooklyn.policies:
  - type: brooklyn.policy.autoscaling.AutoScalerPolicy
    brooklyn.config:
      metric: $brooklyn:sensor("brooklyn.entity.nosql.couchbase.CouchbaseCluster",
        "couchbase.stats.cluster.per.node.ops")
      metricLowerBound: 500
      metricUpperBound: 1000
      minPoolSize: 3
      maxPoolSize: 8

- type: brooklyn.entity.webapp.ControlledDynamicWebAppCluster
  name: Web Couchbase Load Gen Cluster
  war: https://github.com/neykov/web-load-gen/raw/master/load-gen.war
  brooklyn.config:
    provisioning.properties:
      minCores: 4
    java.sysprops:
      brooklyn.example.couchbase.nodes: $brooklyn:formatString("'%s'",
        component("cb-cluster").attributeWhenReady("couchbase.cluster.node.addresses"))
  initialSize: 2

location: aws-ec2:us-east-1
